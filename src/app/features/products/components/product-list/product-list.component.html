<div class="container" 
     infiniteScroll
     [infiniteScrollDistance]="2"
     [infiniteScrollThrottle]="50"
     (scrolled)="onScroll()">
  
  <!-- Controls Section -->
  <div class="d-flex flex-wrap gap-2 align-items-center py-3 border-bottom">
    <!-- Search -->
    <div class="flex-grow-1 position-relative" style="min-width: 200px;">
      <form (ngSubmit)="$event.preventDefault(); loadProducts()" class="input-group">
        <input type="text" 
               class="form-control form-control-sm" 
               name="search"
               [(ngModel)]="searchQuery"
               (ngModelChange)="onSearchInput($event)"
               placeholder="Search products...">
        <button class="btn btn-outline-secondary btn-sm" 
                type="button"
                *ngIf="searchQuery"
                (click)="clearSearch()">
          <i class="bi bi-x"></i>
        </button>
        <button class="btn btn-outline-primary btn-sm" 
                type="submit">
          <i class="bi bi-search"></i>
        </button>
      </form>
    </div>

    <!-- Categories -->
    <div style="min-width: 150px;">
      <select class="form-select form-select-sm" 
              (change)="onCategorySelect($event)"
              [attr.disabled]="loading ? '' : null">
        <option [value]="null">{{ categories.length === 0 ? 'Loading categories...' : 'All Categories' }}</option>
        <option *ngFor="let category of categories" 
                [value]="category.categoryId">
          {{category.categoryName}}
        </option>
      </select>
      <div *ngIf="error" class="text-danger small mt-1">
        {{ error }}
      </div>
    </div>

    <!-- Sort Direction -->
    <div class="d-flex gap-1">
      <button class="btn btn-sm btn-outline-secondary"
              (click)="toggleSortDirection()">
        <i class="bi" [ngClass]="ascending ? 'bi-sort-up' : 'bi-sort-down'"></i>
      </button>
    </div>

    <!-- View Toggle -->
    <button class="btn btn-sm btn-outline-secondary"
            (click)="toggleView()">
      <i class="bi" [ngClass]="isGridView ? 'bi-grid' : 'bi-list'"></i>
    </button>
  </div>

  <!-- Products View -->
  <ng-container *ngIf="isGridView; else listView">
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <div class="col" *ngFor="let product of products">
        <div class="card h-100">
          <img [src]="product.imageUrl" 
               class="card-img-top" 
               [alt]="product.productName">
          <div class="card-body">
            <h5 class="card-title">{{product.productName}}</h5>
            <p class="card-text">{{product.description | slice:0:100}}...</p>
            <div class="d-flex justify-content-between align-items-center">
              <span class="text-primary fw-bold">${{product.price}}</span>
              <div>
                <button class="btn btn-outline-primary me-2"
                        [routerLink]="['/products', product.productId]">
                  View Details
                </button>
                <button class="btn btn-primary"
                        [disabled]="product.stock === 0"
                        (click)="addToCart(product.productId)">
                  Add to Cart
                </button>
              </div>
            </div>
            <small class="text-muted mt-2 d-block">
              {{product.stock}} items in stock
            </small>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #listView>
    <div class="list-group">
      <div class="list-group-item list-group-item-action" 
           *ngFor="let product of products">
        <div class="row align-items-center">
          <div class="col-md-2">
            <img [src]="product.imageUrl || 'assets/placeholder.jpg'" 
                 [alt]="product.productName"
                 class="img-fluid rounded">
          </div>
          <div class="col-md-6">
            <h5 class="mb-1">{{product.productName}}</h5>
            <p class="mb-1">{{product.description | slice:0:150}}...</p>
            <small class="text-muted">
              {{product.stock}} items in stock
            </small>
          </div>
          <div class="col-md-4 text-end">
            <h5 class="text-primary mb-3">${{product.price}}</h5>
            <button class="btn btn-outline-primary me-2"
                    [routerLink]="['/products', product.productId]">
              View Details
            </button>
            <button class="btn btn-primary"
                    [disabled]="product.stock === 0"
                    (click)="addToCart(product.productId)">
              Add to Cart
            </button>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Loading Indicator -->
  <div class="text-center my-4" *ngIf="loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Error Message -->
  <div class="alert alert-danger my-4" *ngIf="error">
    {{ error }}
  </div>

  <!-- No Products Message -->
  <div class="alert alert-info my-4" *ngIf="!loading && !error && (!products || products.length === 0)">
    No products found matching your criteria.
  </div>
</div>
